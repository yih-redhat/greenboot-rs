---
- hosts: ostree_guest
  become: no
  vars:
    total_counter: "0"
    failed_counter: "0"

  tasks:
    # current target host's IP address
    - debug: var=ansible_all_ipv4_addresses
    - debug: var=ansible_facts['distribution_version']
    - debug: var=ansible_facts['distribution']
    - debug: var=ansible_facts['architecture']

    # case: check greenboot* services
    - name: greenboot healthcheck service should be enabled
      block:
        - name: greenboot healthcheck service should be enabled
          command: systemctl is-enabled greenboot-healthcheck
          register: result_greenboot_service

        - assert:
            that:
              - result_greenboot_service.stdout == 'enabled'
            fail_msg: "at least one greenboot service is not enabled"
            success_msg: "greenboot services are enabled"
      always:
        - set_fact:
            total_counter: "{{ total_counter | int + 1 }}"
      rescue:
        - name: failed count + 1
          set_fact:
            failed_counter: "{{ failed_counter | int + 1 }}"

      # case: check greenboot* service status
    - name: greenboot healthcheck service should be active
      block:
        - name: greenboot healthcheck service should be active
          command: systemctl is-active greenboot-healthcheck.service
          register: result_greenboot_active

        - assert:
            that:
              - result_greenboot_active.stdout == "active"
            fail_msg: "greenboot healthcheck service is not active"
            success_msg: "greenboot healthcheck service is active"
      always:
        - set_fact:
            total_counter: "{{ total_counter | int + 1 }}"
      rescue:
        - name: failed count + 1
          set_fact:
            failed_counter: "{{ failed_counter | int + 1 }}"

    # case: check boot-complete.target status
    - name: boot-complete.target should be active
      block:
        - name: check boot-complete.target
          command: systemctl --no-pager status boot-complete.target
          become: yes
          register: result
          retries: 10
          delay: 60
          until: "'inactive' not in result.stdout"

      always:
        - set_fact:
            total_counter: "{{ total_counter | int + 1 }}"
      rescue:
        - name: failed count + 1
          set_fact:
            failed_counter: "{{ failed_counter | int + 1 }}"

    - name: check /boot mount status
      shell: findmnt -r -o OPTIONS -n /boot | awk -F "," '{print $1}'
      register: result_boot_mount_before

    # case: check rollback function if boot error found
    - name: install sanely failing health check unit to test red boot status behavior
      block:
        - name: install sanely failing health check unit to test red boot status behavior
          command: rpm-ostree install --cache-only https://kite-webhook-prod.s3.amazonaws.com/greenboot-failing-unit-1.0-1.el8.noarch.rpm --reboot
          become: yes
          ignore_errors: yes
          ignore_unreachable: yes

        - name: delay 60 seconds before reboot to make system stable
          pause:
            seconds: 60
          delegate_to: 127.0.0.1

        - name: wait for connection to become reachable/usable
          wait_for_connection:
            delay: 30

        - name: waits until instance is reachable
          wait_for:
            host: "{{ ansible_all_ipv4_addresses[0] }}"
            port: 22
            search_regex: OpenSSH
            delay: 10
          register: result_rollback
          until: result_rollback is success
          retries: 6
          delay: 10

        - assert:
            that:
              - result_rollback is succeeded
            fail_msg: "Rollback failed"
            success_msg: "Rollback success"
      always:
        - set_fact:
            total_counter: "{{ total_counter | int + 1 }}"
      rescue:
        - name: failed count + 1
          set_fact:
            failed_counter: "{{ failed_counter | int + 1 }}"

    # case: check fallback log
    - name: fallback log should be found here
      block:
        - name: fallback log should be found here
          command: journalctl -b -0 -u greenboot -u greenboot-healthcheck
          become: yes
          register: result_greenboot_log

        - assert:
            that:
              - "'FALLBACK BOOT DETECTED!' in result_greenboot_log.stdout"
            fail_msg: "Fallback log not found"
            success_msg: "Found fallback log"

      always:
        - set_fact:
            total_counter: "{{ total_counter | int + 1 }}"
      rescue:
        - name: failed count + 1
          set_fact:
            failed_counter: "{{ failed_counter | int + 1 }}"
      when: result_rollback is succeeded

    # case: check boot-complete.target status
    - name: boot-complete.target should be active
      block:
        - name: check boot-complete.target
          command: systemctl --no-pager status boot-complete.target
          become: yes
          register: result
          retries: 10
          delay: 60
          until: "'inactive' not in result.stdout"

      always:
        - set_fact:
            total_counter: "{{ total_counter | int + 1 }}"
      rescue:
        - name: failed count + 1
          set_fact:
            failed_counter: "{{ failed_counter | int + 1 }}"

    # case: check grubenv variable
    - name: grubenv variables should contain boot_success=1
      block:
        - name: grubenv variables should contain boot_success=1
          command: grub2-editenv list
          register: result_grubenv
          become: yes

        - assert:
            that:
              - "'boot_success=1' in result_grubenv.stdout"
            fail_msg: "Not found boot_success=1"
            success_msg: "Found boot_success=1"
      always:
        - set_fact:
            total_counter: "{{ total_counter | int + 1 }}"
      rescue:
        - name: failed count + 1
          set_fact:
            failed_counter: "{{ failed_counter | int + 1 }}"

    - name: check /boot mount status
      shell: findmnt -r -o OPTIONS -n /boot | awk -F "," '{print $1}'
      register: result_boot_mount_after

    - name: /boot status should be preserved
      block:
        - assert:
            that:
              - result_boot_mount_before.stdout == result_boot_mount_after.stdout
            fail_msg: "/boot status is not preserved"
            success_msg: "/boot status is preserved"
      always:
        - set_fact:
            total_counter: "{{ total_counter | int + 1 }}"
      rescue:
        - name: failed count + 1
          set_fact:
            failed_counter: "{{ failed_counter | int + 1 }}"

    - assert:
        that:
          - failed_counter == "0"
        fail_msg: "Run {{ total_counter }} tests, but {{ failed_counter }} of them failed"
        success_msg: "Totally {{ total_counter }} test passed"
